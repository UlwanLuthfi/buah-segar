<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Users | Rayuan Manis Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="./src/plugins/fontawesome-free/css/all.min.css"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="./src/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css"
    />
    <link
      rel="stylesheet"
      href="./src/plugins/datatables-responsive/css/responsive.bootstrap4.min.css"
    />

    <!-- AdminLTE -->
    <link rel="stylesheet" href="./src/css/adminlte.min.css" />
    <link rel="stylesheet" href="./src/css/admin-custom.css" />

    <!-- Javascript -->
    <script src="../src/script/guard.js"></script>
  </head>

  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- LEFT -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#">
              <i class="fas fa-bars"></i>
            </a>
          </li>
        </ul>

        <!-- RIGHT -->
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <button
              onclick="logoutAdmin()"
              class="btn btn-danger btn-sm"
              style="margin-right: 10px"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </li>
        </ul>
      </nav>

      <!-- Sidebar -->
      <aside class="main-sidebar sidebar-dark-pink elevation-4">
        <a href="index.html" class="brand-link">
          <img
            src="./src/img/logo.png"
            class="brand-image"
            alt="Rayuan Manis Logo"
          />
          <span class="brand-text font-weight-light">Rayuan Manis</span>
        </a>

        <div class="sidebar">
          <nav>
            <ul class="nav nav-pills nav-sidebar flex-column">
              <li class="nav-item">
                <a href="index.html" class="nav-link">
                  <i class="nav-icon fas fa-chart-line"></i>
                  <p>Dashboard</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="transactions.html" class="nav-link">
                  <i class="nav-icon fas fa-receipt"></i>
                  <p>Transaksi</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="users.html" class="nav-link active">
                  <i class="nav-icon fas fa-users"></i>
                  <p>User</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="products.html" class="nav-link">
                  <i class="nav-icon fas fa-apple-alt"></i>
                  <p>Produk</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Content -->
      <div class="content-wrapper">
        <section class="content-header">
          <div class="container-fluid">
            <h1>Users</h1>
            <p class="text-muted">Daftar seluruh user Rayuan Manis</p>
          </div>
        </section>

        <section class="content">
          <div class="container-fluid">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Daftar User</h3>

                <div class="card-tools">
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="openAddUser()"
                  >
                    <i class="fas fa-plus"></i> Tambah User
                  </button>
                </div>
              </div>

              <div class="card-body">
                <table
                  id="usersTable"
                  class="table table-bordered table-striped"
                >
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nama</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="main-footer text-sm">
        <strong>Rayuan Manis</strong> Admin Panel
      </footer>
    </div>

    <!-- Modal User -->
    <div class="modal fade" id="userModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Form User</h5>
            <button class="close" data-dismiss="modal">&times;</button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="userId" />

            <div class="form-group">
              <label>Email</label>
              <input type="email" id="userEmail" class="form-control" />
            </div>

            <div class="form-group">
              <label>Password</label>
              <input type="text" id="userPassword" class="form-control" />
            </div>

            <div class="form-group">
              <label>Role</label>
              <select id="userRole" class="form-control">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-dismiss="modal">
              Batal
            </button>
            <button class="btn btn-primary" onclick="saveUser()">Simpan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="./src/plugins/jquery/jquery.min.js"></script>
    <script src="./src/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script src="./src/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="./src/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="./src/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="./src/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>

    <script src="./src/js/adminlte.min.js"></script>
    <script src="../src/script/auth.js"></script>

    <script>
      let userTable;

      function getUsers() {
        return JSON.parse(localStorage.getItem("users")) || [];
      }

      function saveUsers(users) {
        localStorage.setItem("users", JSON.stringify(users));
      }

      function renderUsers() {
        const users = getUsers();
        userTable.clear();

        users.forEach((u, i) => {
          userTable.row.add([
            i + 1,
            u.email.split("@")[0],
            u.email,
            u.role === "admin"
              ? '<span class="badge badge-danger">Admin</span>'
              : '<span class="badge badge-primary">User</span>',
            `
          <button class="btn btn-sm btn-warning" onclick="editUser(${i})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteUser(${i})">
            <i class="fas fa-trash"></i>
          </button>
        `,
          ]);
        });

        userTable.draw();
      }

      function openAddUser() {
        userId.value = "";
        userEmail.value = "";
        userPassword.value = "";
        userRole.value = "user";
        $("#userModal").modal("show");
      }

      function saveUser() {
        const index = userId.value;
        const email = userEmail.value;
        const password = userPassword.value;
        const role = userRole.value;

        if (!email || !password) {
          alert("Email dan password wajib diisi");
          return;
        }

        let users = getUsers();

        if (index !== "") {
          // UPDATE
          users[index] = { email, password, role };
        } else {
          // CREATE
          if (users.find((u) => u.email === email)) {
            alert("Email sudah terdaftar");
            return;
          }

          users.push({ email, password, role });
        }

        saveUsers(users);
        $("#userModal").modal("hide");
        renderUsers();
      }

      function editUser(index) {
        const users = getUsers();
        const user = users[index];
        if (!user) return;

        userId.value = index; // simpan index
        userEmail.value = user.email;
        userPassword.value = user.password;
        userRole.value = user.role;

        $("#userModal").modal("show");
      }

      function deleteUser(index) {
        if (!confirm("Yakin hapus user ini?")) return;

        const users = getUsers();
        users.splice(index, 1);
        saveUsers(users);
        renderUsers();
      }

      $(function () {
        userTable = $("#usersTable").DataTable({
          responsive: true,
          autoWidth: false,
        });

        renderUsers();
      });
    </script>
  </body>
</html>
